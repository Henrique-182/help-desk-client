<div class="users__container">
  <app-toolbar [username]="username" />
  <app-sidebar />

  <div class="nav__container">
    <app-breadcrumb [items]="breadCrumbItems" />
    <div class="content__container">
      <p-table [value]="tableValue" 
      [lazy]="true" 
      [rows]="rows" 
      [totalRecords]="totalElements"
      paginator="true" 
      [showCurrentPageReport]="true" 
      currentPageReportTemplate="{first} - {last} de um total de {totalRecords} usuários"
      (onPage)="handlePageEvent($event)" 
      [rowsPerPageOptions]="[5, 10, 25]"
      [sortField]="'username'"
      (onSort)="handleSortEvent($event)"
      styleClass="p-datatable-sm"
    >

      <!-- TABLE CAPTION -->
      <ng-template pTemplate="caption">
        <div class="flex align-items-center justify-content-space-between">
          <div>
            <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpar filtros" (click)="onClearFilters()" class="margin-right-1-em" />
            <p-button [outlined]="true" icon="pi pi-search" label="Pesquisar" (click)="onRefreshTable()" />
          </div>
          <div>
            <p-button [outlined]="true" severity="success" icon="pi pi-plus" label="Incluir" (click)="isAddUserDialogVisible = true" class="margin-right-1-em" />
            <p-button [outlined]="true" severity="help" icon="pi pi-file-pdf" label="Report" (click)="onUserReport()" />
          </div>
      </div>
      </ng-template>

      <!-- TABLE HEADER -->
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="id">
            Id <p-sortIcon field="id" />
          </th>
          <th pSortableColumn="username">
            <div class="flex justify-content-space-between align-items-center">
              <div>
                Nome de usuário 
                <p-sortIcon field="username" />
              </div>
              <div>
                <p-columnFilter
                  ariaLabel="Filtra usuário"
                  display="menu"
                  [showMatchModes]="false"
                  [showOperator]="false"
                  [showAddButton]="false"
                  [showClearButton]="false"
                >
                  <ng-template pTemplate="filter">
                    <input type="text" placeholder="Busca por nome" pInputText [(ngModel)]="queryUsername">
                  </ng-template>
                </p-columnFilter>
              </div>
            </div>
          </th>
          <th pSortableColumn="fullname">
            <div class="flex justify-content-space-between align-items-center">
              <div>
                Nome Completo 
                <p-sortIcon field="fullname" />
              </div>
              <p-columnFilter
                ariaLabel="Filtra usuário"
                display="menu"
                [showMatchModes]="false"
                [showOperator]="false"
                [showAddButton]="false"
                [showClearButton]="false"
              >
                <ng-template pTemplate="filter">
                  <input type="text" placeholder="Busca por nome" pInputText [(ngModel)]="queryUsername">
                </ng-template>
              </p-columnFilter>
            </div>
          </th>
          <th>
            Ativo
          </th>
          <th>
            Tipo
          </th>
          <th>
            <div class="flex justify-content-space-between align-items-center">
                <div>
                  Permissões
                </div>
                <div>
                  <p-columnFilter 
                    field="enabled"
                    ariaLabel="Filtra usuário"
                    display="menu"
                    [showMatchModes]="false"
                    [showOperator]="false"
                    [showAddButton]="false"
                    [showClearButton]="false"
                  >
                    <ng-template pTemplate="filter">
                      <p-dropdown [(ngModel)]="queryPermission" [options]="permissions" placeholder="Busca por permissão">
                          <ng-template let-permission pTemplate="item">
                              <p-tag [value]="permission.label" />
                          </ng-template>
                      </p-dropdown>
                    </ng-template>
                  </p-columnFilter>
                </div>
            </div>           
          </th>
          <th>
            Ações
          </th>
        </tr>
      </ng-template>

      <!-- TABLE BODY -->
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>{{ user.key }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.fullname }}</td>
          <td>{{ user.enabled | booleanToYn }}</td>
          <td>
            <p-tag  
              [value]="user.type.description | userType"
              [severity]="'info'" 
              [rounded]="true"
            />
          </td>
          <td>
            <p-tag 
              *ngFor="let d of user.permissions" 
              [value]="d.description | userPermission" 
              [rounded]="true"
            />
          </td>
          <td>
            <p-button 
              pRipple
              icon="pi pi-info-circle" 
              [rounded]="true" 
              [outlined]="true" 
              severity="info" 
              (click)="onGetUser(user)" />
            <p-button 
              pRipple
              icon="pi pi-pencil" 
              [rounded]="true" 
              [outlined]="true" 
              severity="success" 
              (click)="onEditUser(user)" />
            <p-button 
              pRipple 
              icon="pi pi-trash" 
              severity="danger" 
              [rounded]="true" 
              [outlined]="true" 
              [hidden]="username === user.username"
              (click)="onDeleteUser(user)" />
          </td>
        </tr>
      </ng-template>
    </p-table>
    </div>
  </div>
  <div class="card flex justify-content-center">
      <app-add-user-dialog [(dialogVisibility)]="isAddUserDialogVisible" (onSaveUserEmitt)="onCreateUser($event)" />
  </div>
</div>